import os
import pandas as pd
import numpy as np
from glob import glob

matrix_dir = "spatial_pairwise_matrices"
zscore_threshold = 2

matrix_files = glob(os.path.join(matrix_dir, "*_spatial_matrix.csv"))
pdb_ids = [os.path.basename(f).split("_")[0] for f in matrix_files]

amino_acids = list("ACDEFGHIKLMNPQRSTVWY")
pair_counts = {}

for file, pdb_id in zip(matrix_files, pdb_ids):
    df = pd.read_csv(file, index_col=0)
    for aa1 in amino_acids:
        for aa2 in amino_acids:
            pair = f"{aa1}-{aa2}"
            count = df.loc[aa1, aa2]
            pair_counts.setdefault(pair, []).append((pdb_id, count))

outlier_summary = []
outlier_details = []

for pair, entries in pair_counts.items():
    counts = np.array([c for _, c in entries])
    mean = counts.mean()
    std = counts.std()

    if std == 0:
        continue

    z_scores = (counts - mean) / std
    outliers = np.abs(z_scores) > zscore_threshold

    for (pdb, count), flag in zip(entries, outliers):
        if flag:
            outlier_details.append({
                "AminoAcid_Pair": pair,
                "PDB_ID": pdb,
                "Count": count,
                "Z_Score": round((count - mean) / std, 3)
            })

    summary = {
        "AminoAcid_Pair": pair,
        "Mean": round(mean, 3),
        "StdDev": round(std, 3),
        "Outlier_Count": int(outliers.sum()),
        "Total_Structures": len(counts),
        "Outlier_Percentage": round((outliers.sum() / len(counts)) * 100, 2)
    }
    outlier_summary.append(summary)

pd.DataFrame(outlier_summary).to_csv("pairwise_outlier_stats.csv", index=False)
pd.DataFrame(outlier_details).to_csv("pairwise_outlier_details.csv", index=False)

print("Outlier summary files created.")
